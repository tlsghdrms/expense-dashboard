<%- include('./include/_header') %>

<div class="container">
    <h2>ì§€ì¶œ ë‚´ì—­</h2>
    <div class="filter-container" style="margin: 20px 0; text-align: right;">
        <form action="/expenses" method="GET" style="display: inline-block;">
            <label for="month" style="font-weight: bold; margin-right: 10px;">ê¸°ê°„ ì„ íƒ:</label>
            <input 
                type="month" 
                id="month" 
                name="month" 
                value="<%= selectedMonth %>"
                style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;"
            >
            <button type="submit" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9rem; margin-left: 5px;">
                ì¡°íšŒ
            </button>
        </form>
    </div>

    <div class="chart-container" style="width: 50%; margin: 20px auto;">
        <canvas id="expenseChart"></canvas>
    </div>
    
    <% if (expenses && expenses.length > 0) { %>
    <table>
        <thead>
        <tr>
            <th>ë‚ ì§œ</th>
            <th>ì œëª©</th>
            <th>ì¹´í…Œê³ ë¦¬</th>
            <th>ê¸ˆì•¡</th>
            <th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        <% expenses.forEach(expense => { %>
        <tr>
            <td><%= expense.date.toISOString().slice(0, 10) %></td>
            <td><%= expense.title %></td>
            <td><%= expense.category %></td>
            <td><%= expense.amount.toLocaleString() %> ì›</td>
            <td>
            <a href="/expenses/edit/<%= expense._id %>" 
                class="btn btn-update"
            >
            ìˆ˜ì •
            </a>
            <form
                action="/expenses/delete/<%= expense._id %>?_method=DELETE"
                method="POST"
                style="display: inline"
                onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
            >

                <button type="submit" class="btn btn-delete">ì‚­ì œ</button>
            </form>
            </td>
        </tr>
        <% }); %>
        </tbody>
    </table>
    <% } else { %>
    <p>í‘œì‹œí•  ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
    <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels =  <%- chartLabels %>;
    const data = <%- chartData %>;

    // ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    if (labels.length > 0) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì§€ì¶œ ê¸ˆì•¡',
                    data: data,
                    backgroundColor: [
                        '#FF6384', // ë¹¨ê°•
                        '#36A2EB', // íŒŒë‘
                        '#FFCE56', // ë…¸ë‘
                        '#4BC0C0', // ì²­ë¡
                        '#9966FF', // ë³´ë¼
                        '#FF9F40'  // ì£¼í™©
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í†µê³„'
                    }
                }
            }
        });
    }
    const aiBtn = document.getElementById('ai-btn');
    
    if (aiBtn) {
        aiBtn.addEventListener('click', async () => {
            const monthInput = document.getElementById('month').value;
            const [year, month] = monthInput.split('-');

            const originalText = aiBtn.innerText;
            aiBtn.innerText = "ğŸ¤” ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";
            aiBtn.disabled = true;

            try {
                const response = await fetch('/expenses/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year, month })
                });

                const data = await response.json();
                
                alert("ğŸ“¢ AI ë¶„ì„ ê²°ê³¼:\n\n" + data.message);

            } catch (error) {
                console.error(error);
                alert("ë¶„ì„ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                aiBtn.innerText = originalText;
                aiBtn.disabled = false;
            }
        });
    }
</script>
<%- include('./include/_footer') %>