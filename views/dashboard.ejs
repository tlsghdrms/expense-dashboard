<%- include('./include/_header') %>

<div class="container">
    <div class="summary-card" style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: flex-start; 
    ">
        <div>
            <h3 style="margin: 0 0 5px 0; font-size: 1.1rem; opacity: 0.9;">
                ğŸ“… <%= selectedMonth %>ì›” ì´ ì§€ì¶œ
            </h3>
            <p style="margin: 0; font-size: 2.5rem; font-weight: bold;">
                <%= totalSpent.toLocaleString() %> <span style="font-size: 1rem;">ì›</span>
            </p>
        </div>
        
        <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
            
            <form action="/expenses" method="GET" style="display: flex; gap: 8px;">
                <input type="hidden" name="category" value="<%= selectedCategory %>">

                <select name="year" onchange="this.form.submit()" style="
                    padding: 6px 10px; 
                    border: 1px solid rgba(255,255,255,0.3); 
                    border-radius: 20px; 
                    font-size: 0.9rem;
                    background-color: rgba(255, 255, 255, 0.2); 
                    color: white;
                    cursor: pointer;
                    outline: none;
                ">
                    <% for(let y = 2023; y <= 2030; y++) { %>
                        <option value="<%= y %>" style="color: black;" <%= y == selectedYear ? 'selected' : '' %>>
                            <%= y %>ë…„
                        </option>
                    <% } %>
                </select>

                <select name="month" onchange="this.form.submit()" style="
                    padding: 6px 10px; 
                    border: 1px solid rgba(255,255,255,0.3); 
                    border-radius: 20px; 
                    font-size: 0.9rem;
                    background-color: rgba(255, 255, 255, 0.2); 
                    color: white;
                    cursor: pointer;
                    outline: none;
                ">
                    <% for(let m = 1; m <= 12; m++) { %>
                        <option value="<%= m %>" style="color: black;" <%= m == selectedMonth ? 'selected' : '' %>>
                            <%= m %>ì›”
                        </option>
                    <% } %>
                </select>
            </form>

            <% if (user.budget > 0) { 
                const percent = Math.min((totalSpent / user.budget) * 100, 100);
                let statusMsg = "ì—¬ìœ  ìˆì–´ìš”! ğŸ˜Š";
                if(percent >= 80) statusMsg = "ì•„ê»´ ì“°ì„¸ìš”! ğŸ˜";
                if(percent >= 100) statusMsg = "ì˜ˆì‚° ì´ˆê³¼! ğŸš¨";
            %>
            <div style="margin-top: 5px;">
                <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">
                    ëª©í‘œ ì˜ˆì‚°: <%= user.budget.toLocaleString() %>ì›
                </p>
                <p style="margin: 2px 0 0 0; font-weight: bold; font-size: 1.1rem;">
                    <%= statusMsg %>
                </p>
            </div>
            <% } %>
        </div>
    </div>

    <div class="chart-container" style="width: 60%; margin: 0 auto 40px auto;">
        <canvas id="expenseChart"></canvas>
    </div>

    <div class="list-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">ğŸ“ ìƒì„¸ ë‚´ì—­</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
            <a href="/expenses/add" class="btn btn-primary" style="font-size: 0.9rem;">+ ì§€ì¶œ ì¶”ê°€</a>
        </div>
    </div>

    <% if (expenses && expenses.length > 0) { %>
    <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <thead>
        <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
            <th style="padding: 12px;">ë‚ ì§œ</th>
            <th style="padding: 12px;">ë‚´ìš©</th>
            <th style="padding: 12px;">ì¹´í…Œê³ ë¦¬</th>
            <th style="padding: 12px;">ê¸ˆì•¡</th>
            <th style="padding: 12px;">ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        <% expenses.forEach(expense => { %>
        <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 12px;"><%= expense.date.toISOString().slice(0, 10) %></td>
            <td style="padding: 12px; font-weight: 500;"><%= expense.title %></td>
            <td style="padding: 12px;">
                <span style="
                    padding: 4px 8px; 
                    border-radius: 12px; 
                    font-size: 0.8rem;
                    background-color: #e9ecef;
                    color: #495057;
                "><%= expense.category %></span>
            </td>
            <td style="padding: 12px; color: #c53030; font-weight: bold;">
                -<%= expense.amount.toLocaleString() %> ì›
            </td>
            <td style="padding: 12px;">
                <a href="/expenses/edit/<%= expense._id %>" style="margin-right: 5px; text-decoration: none;">âœï¸</a>
                <form action="/expenses/delete/<%= expense._id %>?_method=DELETE" method="POST" style="display: inline" onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" style="border: none; background: none; cursor: pointer;">ğŸ—‘ï¸</button>
                </form>
            </td>
        </tr>
        <% }); %>
        </tbody>
    </table>
    <% } else { %>
    <div style="text-align: center; padding: 50px; background: #f8f9fa; border-radius: 8px; color: #868e96;">
        <p>ì‘ì„±ëœ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = <%- chartLabels %>;
    const data = <%- chartData %>;

    if (labels.length > 0) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: 'ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¹„ìœ¨' }
                }
            }
        });
    }
</script>

<%- include('./include/_footer') %>