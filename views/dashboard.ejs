<%- include('./include/_header') %>

<div class="container">
    <h2 class="dashboard-title">
        ğŸ“Š <span class="highlight"><%= selectedMonth %>ì›”</span> ì†Œë¹„ ë¦¬í¬íŠ¸
    </h2>

    <div class="summary-card">
        <div class="summary-left">
            <h3 class="summary-label">ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ ê¸ˆì•¡</h3>
            <p class="summary-amount">
                <%= totalSpent.toLocaleString() %> <span class="unit">ì›</span>
            </p>

            <% if (typeof compareText !== 'undefined') { %>
                <div class="trend-badge <%= isIncrease ? 'increase' : 'decrease' %>">
                    <%= compareText %>
                </div>
            <% } %>

            <% 
                if (user.budget && user.budget > 0) { 
                const percent = Math.min((totalSpent / user.budget) * 100, 100);
                let statusClass = "safe"; 
                if(percent >= 80) statusClass = "warning"; 
                if(percent >= 100) statusClass = "danger"; 
            %>
                <div class="budget-wrapper">
                    <div class="budget-info">
                        <span>ì˜ˆì‚° ì†Œì§„ìœ¨</span>
                        <span><%= Math.round(percent) %>%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill <%= statusClass %>" style="width: <%= percent %>%;"></div>
                    </div>
                    <p class="budget-goal-text">
                        ëª©í‘œ <%= user.budget.toLocaleString() %>ì›
                    </p>
                </div>
            <% } else { %>
                <div class="no-budget-msg">ğŸ’¡ ìš°ì¸¡ì—ì„œ ëª©í‘œ ì˜ˆì‚°ì„ ì„¤ì •í•´ë³´ì„¸ìš”.</div>
            <% } %>
        </div>
        
        <div class="summary-right">    
            <form action="/expenses" method="GET" class="date-filter-form">
                <input type="hidden" name="category" value="<%= selectedCategory %>">
                <select name="year" onchange="this.form.submit()" class="date-select year">
                    <% for(let y = 2023; y <= 2030; y++) { %>
                        <option value="<%= y %>" <%= y == selectedYear ? 'selected' : '' %>><%= y %>ë…„</option>
                    <% } %>
                </select>
                <select name="month" onchange="this.form.submit()" class="date-select month">
                    <% for(let m = 1; m <= 12; m++) { %>
                        <option value="<%= m %>" <%= m == selectedMonth ? 'selected' : '' %>><%= m %>ì›”</option>
                    <% } %>
                </select>
            </form>

            <form action="/expenses/budget" method="POST" class="budget-set-form">
                <input type="number" name="budget" value="<%= user.budget %>" placeholder="ì˜ˆì‚° ì…ë ¥" class="budget-input">
                <button type="submit" class="budget-submit-btn">ì˜ˆì‚° ì„¤ì •</button>
            </form>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="expenseChart"></canvas>
    </div>

    <div class="list-header">
        <h3 class="list-title">ğŸ“ ìƒì„¸ ê±°ë˜ ë‚´ì—­</h3>
        <div class="filter-group">
            <% const cats = ['all', 'ì‹ë¹„', 'êµí†µ', 'ì—¬ê°€', 'ê¸°íƒ€']; const catNames = ['ì „ì²´', 'ì‹ë¹„', 'êµí†µ', 'ì—¬ê°€', 'ê¸°íƒ€']; %>
            <% cats.forEach((c, i) => { %>
                <a href="/expenses?year=<%= selectedYear %>&month=<%= selectedMonth %>&category=<%= c %>" 
                   class="cat-filter-btn <%= selectedCategory === c ? 'active' : '' %>">
                   <%= catNames[i] %>
                </a>
            <% }); %>
            <a href="/expenses/add" class="btn btn-primary btn-add-expense">+ ë“±ë¡</a>
        </div>
    </div>

    <% if (expenses && expenses.length > 0) { %>
    <table class="dashboard-table">
        <thead>
        <tr>
            <th class="th-date">ë‚ ì§œ</th>
            <th class="th-title">ë‚´ìš©</th>
            <th class="th-cat">ë¶„ë¥˜</th>
            <th class="th-amount">ê¸ˆì•¡</th>
            <th class="th-action">ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        <% expenses.forEach(expense => { %>
        <tr>
            <td class="cell-date"><%= expense.date.toISOString().slice(0, 10) %></td>
            <td class="cell-title"><%= expense.title %></td>
            <td>
                <span class="cat-badge"><%= expense.category %></span>
            </td>
            <td class="cell-amount">-<%= expense.amount.toLocaleString() %></td>
            <td class="cell-action">
                <div class="action-wrapper">
                    <a href="/expenses/edit/<%= expense._id %>" class="btn-text-edit">ìˆ˜ì •</a>
                    <span class="action-divider">|</span>
                    <form action="/expenses/delete/<%= expense._id %>?_method=DELETE" method="POST" style="margin: 0;">
                        <button type="submit" class="btn-text-delete">ì‚­ì œ</button>
                    </form>
                </div>
            </td>
        </tr>
        <% }); %>
        </tbody>
    </table>
    <% } else { %>
    <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <p>ì´ë²ˆ ë‹¬ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = <%- chartLabels %>;
    const data = <%- chartData %>;

    if (labels.length > 0) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#036b3f', '#0a8a54', '#4caf50', '#81c784', '#a39346', '#d4c78c'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: { usePointStyle: true, padding: 20, font: { size: 12 } }
                    },
                    title: { display: false }
                },
                cutout: '65%'
            }
        });
    }
</script>

<%- include('./include/_footer') %>