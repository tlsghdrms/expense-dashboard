<%- include('./include/_header') %>

<div class="container">
    
    <% if (typeof notice !== 'undefined' && notice) { %>
        <div style="
            background-color: #f1fcf5; 
            border: 1px solid #c3fae8;
            color: #0ca678;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            animation: fadeIn 0.5s ease-out;
        ">
            <div style="font-size: 1.5rem;">ğŸ“¢</div>
            <div style="flex: 1;">
                <div style="font-weight: 700; margin-bottom: 4px; font-size: 1rem;">
                    <%= notice.title %>
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9; line-height: 1.4;">
                    <%= notice.content %>
                </div>
            </div>
            <div style="font-size: 0.8rem; opacity: 0.7; white-space: nowrap;">
                <%= notice.createdAt ? notice.createdAt.toLocaleDateString() : '' %>
            </div>
        </div>
        
        <style>
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        </style>
    <% } %>

    <h2 style="margin-bottom: 25px; font-size: 1.8rem; border-bottom: none;">
        ğŸ“Š <span style="color: #036b3f; font-weight: 800;"><%= selectedMonth %>ì›”</span> ì†Œë¹„ ë¦¬í¬íŠ¸
    </h2>

    <div class="summary-card" style="
        background-color: #f8f9fa;
        border-left: 6px solid #036b3f;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 40px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    ">
        <div style="flex: 1; min-width: 280px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1rem; color: #666; font-weight: normal;">
                ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ ê¸ˆì•¡
            </h3>
            <p style="margin: 0; font-size: 2.5rem; font-weight: 800; color: #333; letter-spacing: -1px;">
                <%= totalSpent.toLocaleString() %> <span style="font-size: 1.2rem; font-weight: normal; color: #555;">ì›</span>
            </p>

            <% if (typeof compareText !== 'undefined') { %>
                <div style="margin-top: 10px; font-size: 0.95rem; font-weight: 600; color: <%= isIncrease ? '#dc3545' : '#036b3f' %>; background: <%= isIncrease ? 'rgba(220, 53, 69, 0.05)' : 'rgba(3, 107, 63, 0.05)' %>; display: inline-block; padding: 5px 10px; border-radius: 20px;">
                    <%= compareText %>
                </div>
            <% } %>

            <% if (user.budget && user.budget > 0) { 
                const percent = Math.min((totalSpent / user.budget) * 100, 100);
                let statusColor = "#036b3f"; 
                if(percent >= 80) statusColor = "#ffc107"; 
                if(percent >= 100) statusColor = "#dc3545"; 
            %>
                <div style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                        <span>ì˜ˆì‚° ì†Œì§„ìœ¨</span>
                        <span><%= Math.round(percent) %>%</span>
                    </div>
                    <div style="background: #e9ecef; height: 10px; width: 100%; border-radius: 5px; overflow: hidden;">
                        <div style="background: <%= statusColor %>; width: <%= percent %>%; height: 100%;"></div>
                    </div>
                    <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: #888; text-align: right;">
                        ëª©í‘œ <%= user.budget.toLocaleString() %>ì›
                    </p>
                </div>
            <% } else { %>
                <div style="margin-top: 20px; font-size: 0.9rem; color: #888; background: #fff; padding: 10px; border: 1px dashed #ccc; display: inline-block;">
                    ğŸ’¡ ìš°ì¸¡ì—ì„œ ëª©í‘œ ì˜ˆì‚°ì„ ì„¤ì •í•´ë³´ì„¸ìš”.
                </div>
            <% } %>
        </div>
        
        <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 15px;">
            
            <form action="/expenses" method="GET" style="display: flex; gap: 5px; background: #fff; padding: 5px; border: 1px solid #eee; border-radius: 4px;">
                <input type="hidden" name="category" value="<%= selectedCategory %>">
                <select name="year" onchange="this.form.submit()" style="padding: 8px; border: none; font-weight: 600; color: #333; cursor: pointer; outline: none;">
                    <% for(let y = 2023; y <= 2030; y++) { %>
                        <option value="<%= y %>" <%= y == selectedYear ? 'selected' : '' %>><%= y %>ë…„</option>
                    <% } %>
                </select>
                <select name="month" onchange="this.form.submit()" style="padding: 8px; border: none; font-weight: 600; color: #036b3f; cursor: pointer; outline: none;">
                    <% for(let m = 1; m <= 12; m++) { %>
                        <option value="<%= m %>" <%= m == selectedMonth ? 'selected' : '' %>><%= m %>ì›”</option>
                    <% } %>
                </select>
            </form>

            <form action="/expenses/budget" method="POST" style="display: flex; align-items: center; gap: 0;">
                <input type="number" name="budget" value="<%= user.budget %>" placeholder="ì˜ˆì‚° ì…ë ¥" 
                    style="width: 120px; padding: 8px 12px; text-align: right; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px; outline: none;"
                >
                <button type="submit" style="background: #555; color: white; border: 1px solid #555; padding: 8px 15px; font-size: 0.9rem; border-radius: 0 4px 4px 0; cursor: pointer;">ì˜ˆì‚° ì„¤ì •</button>
            </form>

        </div>
    </div>

    <div class="chart-container" style="width: 50%; margin: 0 auto 60px auto;">
        <canvas id="expenseChart"></canvas>
    </div>

    <div class="list-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #036b3f; padding-bottom: 10px;">
        <h3 style="margin: 0; color: #333; font-size: 1.3rem; font-weight: 700;">
            ğŸ“ ìƒì„¸ ê±°ë˜ ë‚´ì—­
        </h3>
        
        <div style="display: flex; gap: 5px;">
            <% const cats = ['all', 'ì‹ë¹„', 'êµí†µ', 'ì—¬ê°€', 'ê¸°íƒ€']; const catNames = ['ì „ì²´', 'ì‹ë¹„', 'êµí†µ', 'ì—¬ê°€', 'ê¸°íƒ€']; %>
            <% cats.forEach((c, i) => { %>
                <a href="/expenses?year=<%= selectedYear %>&month=<%= selectedMonth %>&category=<%= c %>" 
                   style="
                       padding: 8px 16px; 
                       font-size: 0.9rem; 
                       border-radius: 20px;
                       font-weight: 600;
                       background: <%= selectedCategory === c ? '#036b3f' : '#f1f3f5' %>; 
                       color: <%= selectedCategory === c ? '#fff' : '#495057' %>;
                       text-decoration: none;
                       transition: all 0.2s;
                   ">
                   <%= catNames[i] %>
                </a>
            <% }); %>
            <a href="/expenses/add" class="btn btn-primary" style="margin-left: 10px; border-radius: 20px; padding: 8px 16px;">+ ë“±ë¡</a>
        </div>
    </div>

    <% if (expenses && expenses.length > 0) { %>
    <table style="border-top: none;">
        <thead>
        <tr style="background: #fff;">
            <th width="12%" style="color: #888; font-weight: 500; border-bottom: 1px solid #ddd;">ë‚ ì§œ</th>
            <th width="38%" style="color: #888; font-weight: 500; border-bottom: 1px solid #ddd;">ë‚´ìš©</th>
            <th width="15%" style="color: #888; font-weight: 500; border-bottom: 1px solid #ddd;">ë¶„ë¥˜</th>
            <th width="20%" style="text-align: right; color: #888; font-weight: 500; border-bottom: 1px solid #ddd;">ê¸ˆì•¡</th>
            <th width="15%" style="text-align: center; color: #888; font-weight: 500; border-bottom: 1px solid #ddd;">ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        <% expenses.forEach(expense => { %>
        <tr>
            <td style="color: #666;"><%= expense.date.toISOString().slice(0, 10) %></td>
            <td style="font-weight: 600; color: #333;"><%= expense.title %></td>
            <td>
                <span style="font-size: 0.8rem; color: #555; background: #f1f3f5; padding: 3px 8px; border-radius: 4px;">
                    <%= expense.category %>
                </span>
            </td>
            <td style="text-align: right; color: #036b3f; font-weight: 700; font-size: 1.05rem;">
                -<%= expense.amount.toLocaleString() %>
            </td>
            <td style="text-align: center; white-space: nowrap;">
                <div style="display: inline-flex; align-items: center; justify-content: center; gap: 10px;">
                    <a href="/expenses/edit/<%= expense._id %>" style="color: #999; text-decoration: none; font-size: 0.9rem;">ìˆ˜ì •</a>
                    <span style="color: #ddd; font-size: 0.8rem;">|</span>
                    <form action="/expenses/delete/<%= expense._id %>?_method=DELETE" method="POST" style="margin: 0;">
                        <button type="submit" style="border: none; background: none; cursor: pointer; color: #dc3545; font-size: 0.9rem; padding: 0;">ì‚­ì œ</button>
                    </form>
                </div>
            </td>
        </tr>
        <% }); %>
        </tbody>
    </table>
    <% } else { %>
    <div style="text-align: center; padding: 80px; color: #bbb; background: #fcfcfc; border-bottom: 1px solid #eee; margin-top: 20px;">
        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“­</div>
        <p>ì´ë²ˆ ë‹¬ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = <%- chartLabels %>;
    const data = <%- chartData %>;

    if (labels.length > 0) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#036b3f', '#0a8a54', '#4caf50', '#81c784', '#a39346', '#d4c78c'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: { usePointStyle: true, padding: 20, font: { size: 12 } }
                    },
                    title: { display: false }
                },
                cutout: '65%'
            }
        });
    }
</script>

<%- include('./include/_footer') %>